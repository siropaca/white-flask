# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際の Claude Code (claude.ai/code) への指示を提供します。

## プロジェクト概要

White Flask は pnpm workspace を使用したモノレポ構造による個人ブログサイトプロジェクトです。3つのアプリケーションから構成されています：

- `apps/blog` - ブログサイトフロントエンド (Next.js)
- `apps/admin` - 管理画面 (SvelteKit)
- `apps/backend` - GraphQL API (Pothos + GraphQL Yoga)

## 開発コマンド

### 基本コマンド（ルートディレクトリから実行）

```bash
# 全アプリケーションを開発モードで起動
pnpm dev

# 全アプリケーションをビルド
pnpm build

# 全パッケージでリンティング実行
pnpm lint
pnpm lint:fix  # リンティング問題を自動修正

# コードフォーマット（Prettier）
pnpm format       # 全ファイルをフォーマット
pnpm format:check # フォーマットチェックのみ

# 型チェック
pnpm type-check

# テスト実行
pnpm test
```

### 初期セットアップ

```bash
# プロジェクトセットアップのためのブートストラップスクリプト実行
mise run bootstrap
# または
./scripts/bootstrap.sh

# PostgreSQL データベース起動
docker-compose up -d
```

### アプリケーション別コマンド

特定のアプリで作業する際は、それぞれのディレクトリからコマンドを実行できます：

- `apps/admin`：Vite/SvelteKit コマンドを使用 (dev, build, preview)
- `apps/backend`：開発には tsx (`pnpm dev`)、ビルドには tsc を使用
- `apps/blog`：Next.js コマンドを使用 (dev, build, start, lint)

## アーキテクチャと主要パターン

### モノレポ構造

- `pnpm-workspace.yaml` で定義された pnpm workspace を使用
- 共有 TypeScript 設定は `tsconfig.base.json` から継承
- 各アプリは独自の `package.json` と特定の依存関係を持つ

### 技術スタック

- **フロントエンド**：Next.js（ブログ）と SvelteKit（管理画面）
- **バックエンド**：Pothos スキーマビルダーと GraphQL Yoga サーバーによる GraphQL
- **データベース**：Drizzle ORM を使用した PostgreSQL（Docker 経由）
- **Node.js**：バージョン 24.2.0（mise で管理）

### 開発ワークフロー

- Lefthook によるプリコミット型チェックのための Git フック
- Commitlint による Conventional Commits 形式の強制
- 全パッケージでのコード品質のための ESLint
- Prettier によるコードフォーマットの統一（ESLint と競合しない設定）

## アプリケーション別ドキュメント

各アプリケーションには詳細情報を含む独自の CLAUDE.md ファイルがあります：

- `apps/admin/CLAUDE.md` - SvelteKit 管理画面の詳細
- `apps/blog/CLAUDE.md` - Next.js ブログサイトの詳細
- `apps/backend/CLAUDE.md` - GraphQL API の詳細

## Documentation Guidelines

### Language Requirements

- **CLAUDE.md および README ファイルは日本語で記述すること**
- コメントやドキュメントは日本語で書く
- ユーザー向けドキュメントは日本語での説明を優先する

### Implementation Guidelines

- **実装を行う際は必ず Context7 の MCP を使用して最新版のドキュメントを参照すること**
- 新しいライブラリやフレームワークを使用する前に、Context7 で最新の使用方法を確認する
- API や設定方法が変更されている可能性があるため、古い知識に頼らず最新情報を取得する
- 特に以下の場合は必須：
  - 新しいパッケージのインストールや設定
  - ライブラリの使用方法やベストプラクティスの確認
  - フレームワークの最新機能や推奨パターンの学習

### Package Management Guidelines

- **ライブラリをインストールする際は、キャレット（^）を使用せずに正確なバージョンを指定すること**
- 例：`pnpm add package-name@1.2.3`（`pnpm add package-name@^1.2.3` ではない）
- これにより、依存関係の予期しない更新による問題を防ぎます
- **package.json を修正した後は必ず `pnpm sort` コマンドを実行すること**
- これにより package.json 内のキーが適切な順序に保たれます

### Code Quality Guidelines

- **ソースコードを修正した後は必ず `pnpm fix` コマンドを実行すること**
- これにより ESLint の自動修正と Prettier によるフォーマットが適用されます
- コードの品質と一貫性が保たれます

## 重要な学習事項と注意点

### ベストプラクティス確認の重要性

- **技術的な推奨事項を提供する前に、必ず Context7 MCP で最新のベストプラクティスを確認すること**
- 特に以下の場合は事前確認が必須：
  - ORM やデータベースマイグレーション戦略
  - ファイル管理（Git 管理対象の判断）
  - デプロイメント設定
  - セキュリティ関連の設定

### 一貫性のある回答の提供

- **最初の回答で不正確な情報を提供した場合は、即座に Context7 で確認して訂正すること**
- 推測や古い知識に基づく回答ではなく、常に最新の公式ドキュメントに基づいた回答を行う
- 複数の異なる回答を提供して混乱を招かないよう注意する

## デプロイメント・インフラ関連の重要な学習事項

### プラットフォーム固有機能の優先調査

- **技術的解決策を提示する前に、必ず使用プラットフォームの固有機能を Context7 や Web Search で調査すること**
- **特にデプロイメント・インフラ関連の問題では、以下の順序で調査を行う：**
  1. **プラットフォーム固有の設定オプション**（各プラットフォームの deploy hooks、lifecycle scripts など）
  2. **業界標準のベストプラクティス**
  3. **汎用的な設定ファイルでの対応**（Docker、CI/CD pipeline など）
  4. **コード内での回避策**（最後の手段）

### インフラ処理の責務分離原則

- **インフラ関連タスクの実行場所について優先順位を持つ：**
  - **第一選択**: プラットフォーム専用機能（Railway の preDeployCommand、Vercel の Build Command、Heroku の Release Phase など）
  - **第二選択**: CI/CD パイプライン（GitHub Actions、GitLab CI など）
  - **第三選択**: コンテナ・設定ファイル（Dockerfile、docker-compose.yml など）
  - **第四選択**: 環境変数やフラグによる条件分岐
  - **最終手段**: アプリケーションコード内での直接実行

- **プログラムコードの責務を明確に分離する**
  - **アプリケーションロジック** ≠ **インフラストラクチャ処理**
  - データベースマイグレーション、環境設定、起動前処理の分離を意識する
  - ビジネスロジックとデプロイメントロジックの混在を避ける

### 問題解決のアプローチ改善

- **「この方法しかない」と断言する前に、必ず複数の代替手段を調査すること**
- **ユーザーが技術的懸念を示した場合は、その直感を尊重し、より良い解決策を再調査する**
- **特にアーキテクチャやベストプラクティスに関わる内容では、複数の情報源で確認する**
- **プラットフォーム名 + 問題のキーワードで具体的に検索する**（例：「Vercel database migration」「AWS Lambda cold start」「Docker build optimization」）

## 継続的学習とドキュメント改善プロセス

### 反省・学習の実施方針

- **ユーザーから「反省して」「学習して」と指摘された場合は、以下の手順で CLAUDE.md を更新すること：**

#### 1. 反省点の分析と汎用化
- 特定の技術・プラットフォームに限定しすぎず、**汎用的な原則**として記載する
- 単発の問題ではなく、**再発防止可能なパターン**として整理する
- 具体例は複数のプラットフォーム・技術から選んで幅広くカバーする

#### 2. 学習事項の構造化
- **問題の根本原因**：なぜそのアプローチを選んでしまったのか
- **改善されたアプローチ**：今後どのような手順で問題解決すべきか
- **判断基準の明確化**：どの選択肢を優先すべきかの基準
- **調査方法の改善**：より効果的な情報収集方法

#### 3. CLAUDE.md への記載ルール
- **新しいセクション**として追加する（既存セクションの単純な修正ではなく）
- **具体的で実行可能な指針**を含める
- **将来の類似問題に適用可能**な形で記述する
- **複数の領域・技術に適用可能**な形で汎用化する

### ドキュメント進化の継続性

- この学習プロセス自体も継続的に改善し、より効果的な反省・学習システムを構築する
- 蓄積された学習事項は定期的に見直し、重複や古くなった内容を整理する
- ユーザーからのフィードバックを積極的に取り入れ、ドキュメントの質を向上させる
